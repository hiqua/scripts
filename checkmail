#!/bin/sh
set -e
set -u

# For notmuch and imapfilter
. "$ZDOTDIR"/10_globals.zsh
. "$ZDOTDIR"/11_locals.zsh

LOG="$USERTMP"/checkmail
date >> "$LOG"


email_sync(){
  imapfilter >> "$LOG" || return "$?"
  mbsync -q -c "${XDG_CONFIG_HOME:-$HOME/.config}"/mbsync/mbsyncrc -a >> "$LOG" || return "$?"

# For notmuch
. "$ZDOTDIR"/10_globals.zsh
. "$ZDOTDIR"/11_locals.zsh

# cat to avoid non-zero return value from grep
notmuch new -q 2>&1 >/dev/null |\
  grep -v "Note: Ignoring non-mail file:" |\
  cat >> "$LOG"
}

# retry in case of failures, and print stderr from last attempt
email_sync 2>/dev/null || email_sync 2>/dev/null || email_sync
