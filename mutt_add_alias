#!/bin/sh
set -e
set -u
LOCK_FILE="$HOME"/.mutt/aliases_lock

ignore(){
  printf "%s" "$*" | grep 'noreply\|no-reply\|announce\|list' > /dev/null
}

MESSAGE="$(cat)"


if addr=$(echo "$MESSAGE" | grep '^From: ' | sed "s/[\,\"\']//g" | grep -o '<.*>') ; then
  if ignore "$addr"; then
    echo "$MESSAGE"
    exit 0;
  fi

  cleanaddr=$(echo "$addr" | sed 's/[<>]*//g')
  NEWALIAS="alias $cleanaddr $addr"

  if ! grep -Fxq "$NEWALIAS" "$HOME"/.mutt/aliases.txt ; then
    if [ ! -e "$LOCK_FILE" ]; then
      touch "$LOCK_FILE"
      echo "$NEWALIAS" >> "$HOME"/.mutt/aliases.txt
      rm "$LOCK_FILE"
    fi
  fi
fi

echo "$MESSAGE"
