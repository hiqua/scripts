#!/bin/sh
# set -e
set -u

watch_plan(){
  # refactor
  printf 'activities.txt' | entr -d sh -c '
  plan_fn=plan_"$(hostname)".txt
  ./tiro < activities.txt > "$plan_fn"
  act_date="$(head -n 1 activities.txt)"
  clear
  cat "$plan_fn"
  subfolder=history/"$(date -d "$act_date" +"%Y-w%V")"/"$(date -d "$act_date" +"%Y-%m-%d")"
  mkdir -p "$subfolder"/archive
  cur_date="$(date --iso-8601=ns)"
  # ignore no match
  (cd $subfolder && mv plan_*.txt activities_*.txt archive/) 2>/dev/null
  cp "$plan_fn" "$subfolder"/plan_"$cur_date".txt
  cp activities.txt "$subfolder"/activities_"$cur_date".txt
  '
}


while true; do
  watch_plan
done
